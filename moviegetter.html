<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Moviegetter</title>


    <!--- jQuery  -------------------------------------------------->

    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous">
    </script>

  </head>

  <body>

    <div id="theResults"></div>
    <JavaScript Link and Code ------------------------------------------>
      <!-- <script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script> -->
      <script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script>
      <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyCuLJPX2_o3RXXOcRqy_5XTtC0RcdNU2R8",
        authDomain: "testingimportere.firebaseapp.com",
        databaseURL: "https://testingimportere.firebaseio.com",
        storageBucket: "testingimportere.appspot.com",
        messagingSenderId: "883800776726"
      };
      firebase.initializeApp(config);
      </script>
      <script>

      var database = firebase.database();
      $(document).ready(function() {

        var genre = {
          genreId: 0,
          genreName: ""
        };

        var theMovie = {
          movieId : 0,
          movieName: "",
          movieDescription: "",
          movieGenres: [],
          movieImage: "",
        }


        var theMovies = [];

        //loops through the genres and gets 40 movies, waits 15 seconds and gets the next one.  It prints them out in csv format on this page in a div above.

        function getMoviesfromArrayIDs(genreids) {
          var pageArray = [];
          // turn genreids values into an array]
          $.each(genreids, function(i) {
            setTimeout(function() {
              console.log(typeof genreids[i])
              console.log(genreids[i])
              var settings = {
                "async": true,
                "crossDomain": true,
                "url": "https://api.themoviedb.org/3/genre/ " + genreids[i] + "+/movies?sort_by=created_at.asc&include_adult=false&language=en-US&api_key=9e47aea3d7ab855ced2fcc031863b928",
                "method": "GET",
                "headers": {},
                "data": "{}"
              }
              $.ajax(settings).done(function(response) {
                var theResults = response.results
                $.each(theResults, function(k) {
                  theMovie.movieId = theResults[k].id;
                  theMovie.movieName = theResults[k].original_title;
                  theMovie.movieDescription = theResults[k].overview;
                  theMovie.movieGenres = theResults[k].genre_ids;
                  theMovie.movieImage = "https://image.tmdb.org/t/p/w640"+theResults[k].poster_path;
                    database.ref('movies').push({theMovie});
                  //
                })
                theMovies.push(JSON.stringify(response));
                console.log(JSON.stringify(response))
                console.log(theMovies)
              })
            }, i * 3000);
            $("#theResults").text(theMovies)
          })
        }

        // gets the genres in JSON and parse out the Genre ids
        function getObjectGenresIdsWithAjax() {
          console.log("got to the first function")
          var settings = {
            "async": true,
            "crossDomain": true,
            "url": "https://api.themoviedb.org/3/genre/movie/list?language=en-US&api_key=9e47aea3d7ab855ced2fcc031863b928",
            "method": "GET",
            "headers": {},
            "data": "{}"
          }
          $.ajax(settings).done(function(response) {
            var genreObjectArray = response.genres;
            console.log(JSON.stringify(genreObjectArray));
            console.log(typeof genreObjectArray);
            console.log(genreObjectArray.length);
            // this part pushes the genres to the database
            $.each(genreObjectArray, function(x) {
              genre.genreId = genreObjectArray[x].id;
              genre.genreName = genreObjectArray[x].name;
              database.ref('genres').push({genre});
            });
            var theArrayGenreIds = [];
            for (var i = 0; i < genreObjectArray.length; i++) {
              theArrayGenreIds.push(genreObjectArray[i]["id"]); // I should now have the genre Ids alone in an array.
            }
          getMoviesfromArrayIDs(theArrayGenreIds)
        })

      }        getObjectGenresIdsWithAjax();

    })
      </script>

  </body>

</html>
